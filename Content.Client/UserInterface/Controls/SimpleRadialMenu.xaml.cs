using Robust.Client.UserInterface;
using System.Numerics;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Shared.Utility;
using Robust.Client.GameObjects;
using Robust.Shared.Timing;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.UserInterface.Controls;

[GenerateTypedNameReferences]
public partial class SimpleRadialMenu : RadialMenu
{
    private readonly EntityUid? _attachMenuToEntity;

    [Dependency] private readonly IClyde _clyde = default!;
    [Dependency] private readonly IEntityManager _entManager = default!;

    public SimpleRadialMenu()
    {

    }

    public SimpleRadialMenu(IEnumerable<RadialMenuButtonModel> models, EntityUid? attachMenuToEntity = null)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _attachMenuToEntity = attachMenuToEntity;
        var sprites = _entManager.System<SpriteSystem>();

        Fill(models, sprites, Children);
    }

    private static void Fill(IEnumerable<RadialMenuButtonModel> models, SpriteSystem sprites, ICollection<Control> rootControlChildren)
    {
        var rootContainer = new RadialContainer
        {
            HorizontalExpand = true,
            VerticalExpand = true,
            InitialRadius = 100,
            ReserveSpaceForHiddenChildren = false,
            Visible = true
        };
        rootControlChildren.Add(rootContainer);

        foreach (var model in models)
        {
            if (model.IsContainer)
            {
                var linkButton = RecursiveContainerExtraction(sprites, rootControlChildren, model);
                linkButton.Visible = true;
                rootContainer.AddChild(linkButton);
            }
            else
            {
                var rootButtons = ConvertToButton(model, sprites);
                rootContainer.AddChild(rootButtons);
            }
        }
    }

    private static RadialMenuTextureButtonWithSector RecursiveContainerExtraction(
        SpriteSystem sprites,
        ICollection<Control> rootControlChildren,
        RadialMenuButtonModel model
    )
    {
        var container = new RadialContainer
        {
            HorizontalExpand = true,
            VerticalExpand = true,
            InitialRadius = 100,
            ReserveSpaceForHiddenChildren = false,
            Visible = false
        };
        foreach (var nested in model.Nested)
        {
            if (nested.IsContainer)
            {
                var linkButton = RecursiveContainerExtraction(sprites, rootControlChildren, nested);
                container.AddChild(linkButton);
            }
            else
            {
                var button = ConvertToButton(nested, sprites);
                container.AddChild(button);
            }
        }
        rootControlChildren.Add(container);

        var thisLayerLinkButton = ConvertToButton(model, sprites);
        thisLayerLinkButton.TargetLayer = container;
        return thisLayerLinkButton;
    }

    private static RadialMenuTextureButtonWithSector ConvertToButton(
        RadialMenuButtonModel model,
        SpriteSystem sprites
    )
    {
        var button = new RadialMenuTextureButtonWithSector
        {
            SetSize = new Vector2(64f, 64f),
            ToolTip = model.ToolTip,
        };
        if (model.Sprite != null)
        {
            button.TextureNormal = sprites.Frame0(model.Sprite);
        }
        button.OnPressed += _ =>
        {
            model.OnPressed?.Invoke();
        };
        return button;
    }

    #region target entity tracking

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);
        if (_attachMenuToEntity != null)
        {
            UpdatePosition();
        }
    }

    private void UpdatePosition()
    {
        if (!_entManager.TryGetComponent(_attachMenuToEntity, out TransformComponent? xform))
        {
            Close();
            return;
        }

        if (!xform.Coordinates.IsValid(_entManager))
        {
            Close();
            return;
        }

        var coords = _entManager.System<SpriteSystem>().GetSpriteScreenCoordinates((_attachMenuToEntity.Value, null, xform));

        if (!coords.IsValid)
        {
            Close();
            return;
        }

        OpenScreenAt(coords.Position, _clyde);
    }

    #endregion
}


public class RadialMenuButtonModel // maybe not model but option? eh
{
    public string? ToolTip;
    
    public RadialMenuButtonModel(Action onPressed)
    {
        OnPressed = onPressed;
    }

    public RadialMenuButtonModel(IReadOnlyCollection<RadialMenuButtonModel> nested)
    {
        Nested = nested;
    }

    public IReadOnlyCollection<RadialMenuButtonModel> Nested { get; } = Array.Empty<RadialMenuButtonModel>();

    public Action? OnPressed { get; }

    public SpriteSpecifier? Sprite { get; init; }

    public bool IsContainer => Nested.Count > 0;
}
